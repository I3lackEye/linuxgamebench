"""
MangoHud Config Manager.

Temporarily replaces the default MangoHud config for benchmarking.
"""

import shutil
from pathlib import Path
from typing import Optional


class MangoHudConfigManager:
    """Manages MangoHud configuration for benchmarking."""

    def __init__(self):
        self.config_dir = Path.home() / ".config" / "MangoHud"
        self.config_file = self.config_dir / "MangoHud.conf"
        self.backup_file = self.config_dir / "MangoHud.conf.lgb_backup"
        self._backup_created = False

        # Auto-restore if backup exists from crashed session
        self._auto_restore_if_needed()

    def _auto_restore_if_needed(self) -> None:
        """Restore backup if it exists from a previous crashed session."""
        if self.backup_file.exists():
            try:
                shutil.copy2(self.backup_file, self.config_file)
                self.backup_file.unlink()
            except Exception:
                pass

    def backup_config(self) -> bool:
        """Backup the current MangoHud config."""
        if not self.config_file.exists():
            return True

        try:
            shutil.copy2(self.config_file, self.backup_file)
            self._backup_created = True
            return True
        except Exception:
            return False

    def restore_config(self) -> bool:
        """Restore the original MangoHud config."""
        if not self._backup_created:
            return True

        try:
            if self.backup_file.exists():
                shutil.copy2(self.backup_file, self.config_file)
                self.backup_file.unlink()
            self._backup_created = False
            return True
        except Exception:
            return False

    def set_benchmark_config(
        self,
        output_folder: Path,
        show_hud: bool = True,
        log_interval: int = 0,
        manual_logging: bool = False,
        log_duration: int = 0,
    ) -> bool:
        """
        Set MangoHud config for benchmarking.

        Args:
            output_folder: Where to save log files
            show_hud: Whether to show the HUD overlay
            log_interval: Logging interval in ms (0 = per-frame)
            manual_logging: If True, user must press Shift+F2 to start/stop recording
            log_duration: Recording duration in seconds (0 = unlimited)
        """
        # Ensure config directory exists
        self.config_dir.mkdir(parents=True, exist_ok=True)

        config_lines = [
            "# MangoHud Benchmark Config",
            "# Generated by Linux Game Benchmark",
            "# Original config backed up to MangoHud.conf.lgb_backup",
            "",
            "### Logging Settings ###",
            f"output_folder={output_folder}",
            "log_versioning",
            f"log_interval={log_interval}",
        ]

        if log_duration > 0:
            config_lines.append(f"log_duration={log_duration}")

        if manual_logging:
            # User controls logging with Shift+F2
            config_lines.append("toggle_logging=Shift_L+F2")
        else:
            config_lines.append("autostart_log")

        config_lines.extend([
            "",
            "### Display Settings ###",
        ])

        if show_hud:
            config_lines.extend([
                "legacy_layout=false",
                "position=top-left",
                "font_size=24",
                "background_alpha=0.5",
                "",
                "fps",
                "frametime",
                "frame_timing",
                "gpu_stats",
                "gpu_temp",
                "gpu_power",
                "cpu_stats",
                "cpu_temp",
                "cpu_power",
                "ram",
                "vram",
            ])
        else:
            config_lines.append("no_display")

        config_lines.extend([
            "",
            "### Metrics to Log ###",
            "fps",
            "frametime",
            "cpu_stats",
            "gpu_stats",
            "ram",
            "vram",
            "cpu_temp",
            "gpu_temp",
            "gpu_core_clock",
            "gpu_mem_clock",
            "gpu_power",
            "cpu_power",
            "cpu_mhz",
            "resolution",
        ])

        try:
            self.config_file.write_text("\n".join(config_lines))
            return True
        except Exception:
            return False


def setup_benchmark_logging(output_folder: Path, show_hud: bool = True) -> MangoHudConfigManager:
    """
    Setup MangoHud for benchmark logging.

    Args:
        output_folder: Where to save logs
        show_hud: Whether to show overlay

    Returns:
        ConfigManager instance (call restore_config() when done)
    """
    manager = MangoHudConfigManager()
    manager.backup_config()
    manager.set_benchmark_config(output_folder, show_hud)
    return manager
