"""
MangoHud Manager.

Handles MangoHud configuration for benchmark logging.
"""

import os
import shutil
import subprocess
from datetime import datetime
from pathlib import Path
from typing import Optional


class MangoHudManager:
    """Manages MangoHud configuration and logging for benchmarks."""

    # Default metrics to log
    DEFAULT_METRICS = [
        "fps",
        "frametime",
        "cpu_stats",
        "gpu_stats",
        "ram",
        "vram",
        "cpu_temp",
        "gpu_temp",
        "gpu_core_clock",
        "gpu_mem_clock",
        "gpu_power",
        "cpu_power",
        "cpu_mhz",
    ]

    def __init__(
        self,
        output_dir: Optional[Path] = None,
        log_interval: int = 0,
        log_duration: int = 0,
    ):
        """
        Initialize MangoHud manager.

        Args:
            output_dir: Directory for log files. Defaults to ~/benchmark_results.
            log_interval: Logging interval in ms. 0 = per-frame.
            log_duration: Max log duration in seconds. 0 = unlimited.
        """
        self.output_dir = output_dir or Path.home() / "benchmark_results"
        self.log_interval = log_interval
        self.log_duration = log_duration
        self._config_path: Optional[Path] = None

    @staticmethod
    def is_installed() -> bool:
        """Check if MangoHud is installed."""
        return shutil.which("mangohud") is not None

    @staticmethod
    def get_version() -> Optional[str]:
        """Get MangoHud version."""
        try:
            result = subprocess.run(
                ["mangohud", "--version"],
                capture_output=True,
                text=True,
            )
            # Version output varies, try to extract version number
            output = result.stdout.strip() or result.stderr.strip()
            if output:
                # Try common patterns
                for line in output.split("\n"):
                    if "MangoHud" in line or "mangohud" in line.lower():
                        return line.strip()
                return output.split("\n")[0].strip()
        except Exception:
            pass
        return None

    def prepare_log_directory(self, game_name: str, run_id: Optional[str] = None) -> Path:
        """
        Prepare directory for benchmark logs.

        Args:
            game_name: Name of the game being benchmarked.
            run_id: Optional run identifier.

        Returns:
            Path to the log directory.
        """
        # Sanitize game name for filesystem
        safe_name = "".join(c if c.isalnum() or c in "._- " else "_" for c in game_name)
        safe_name = safe_name.strip().replace(" ", "_")

        # Create timestamped subdirectory
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        if run_id:
            dir_name = f"{safe_name}_{timestamp}_{run_id}"
        else:
            dir_name = f"{safe_name}_{timestamp}"

        log_dir = self.output_dir / dir_name
        log_dir.mkdir(parents=True, exist_ok=True)

        return log_dir

    def generate_config(
        self,
        log_dir: Path,
        extra_metrics: Optional[list[str]] = None,
        show_hud: bool = False,
    ) -> str:
        """
        Generate MangoHud config for benchmarking.

        Args:
            log_dir: Directory where logs should be saved.
            extra_metrics: Additional metrics to log.
            show_hud: Whether to show the HUD overlay (usually False for benchmarks).

        Returns:
            Config file content as string.
        """
        metrics = self.DEFAULT_METRICS.copy()
        if extra_metrics:
            metrics.extend(extra_metrics)

        # Build config lines
        config_lines = [
            "# MangoHud Benchmark Config",
            "# Generated by Linux Game Benchmark",
            "",
            "### Logging Settings ###",
            f"output_folder={log_dir}",
            "log_versioning",
            f"log_interval={self.log_interval}",
        ]

        if self.log_duration > 0:
            config_lines.append(f"log_duration={self.log_duration}")

        # Toggle logging with F12 key
        config_lines.extend([
            "",
            "### Logging Toggle ###",
            "toggle_logging=F12",
            "autostart_log",  # Start logging automatically
            "",
            "### HUD Display ###",
        ])

        if show_hud:
            # Minimal HUD for benchmarking
            config_lines.extend([
                "fps",
                "frametime",
                "frame_timing",
                "cpu_temp",
                "gpu_temp",
                "position=top-left",
                "font_size=18",
                "background_alpha=0.5",
            ])
        else:
            # Hide HUD completely
            config_lines.append("no_display")

        # Metrics to capture (for logging, not display)
        config_lines.extend([
            "",
            "### Logged Metrics ###",
            "# These are logged to CSV regardless of display",
        ])

        for metric in metrics:
            config_lines.append(metric)

        return "\n".join(config_lines)

    def write_config(
        self,
        log_dir: Path,
        extra_metrics: Optional[list[str]] = None,
        show_hud: bool = False,
    ) -> Path:
        """
        Write MangoHud config file for benchmarking.

        Args:
            log_dir: Directory where logs should be saved.
            extra_metrics: Additional metrics to log.
            show_hud: Whether to show the HUD overlay.

        Returns:
            Path to the config file.
        """
        config_content = self.generate_config(log_dir, extra_metrics, show_hud)

        # Write to log directory
        config_path = log_dir / "MangoHud.conf"
        config_path.write_text(config_content)
        self._config_path = config_path

        return config_path

    def get_environment(
        self,
        config_path: Optional[Path] = None,
        enable_mangohud: bool = True,
    ) -> dict[str, str]:
        """
        Get environment variables for running game with MangoHud.

        Args:
            config_path: Path to MangoHud config. Uses last written if None.
            enable_mangohud: Whether to enable MangoHud.

        Returns:
            Dictionary of environment variables to set.
        """
        env = os.environ.copy()

        if not enable_mangohud:
            return env

        # Use provided config or last written
        cfg = config_path or self._config_path

        if cfg:
            env["MANGOHUD_CONFIGFILE"] = str(cfg)

        # Enable MangoHud
        env["MANGOHUD"] = "1"

        # Disable VSync for MangoHud (let game control it)
        # env["MANGOHUD_VSYNC"] = "0"

        return env

    def get_launch_command(
        self,
        game_command: list[str],
        config_path: Optional[Path] = None,
    ) -> list[str]:
        """
        Wrap game command with MangoHud.

        Args:
            game_command: Original game launch command.
            config_path: Path to MangoHud config.

        Returns:
            Modified command with MangoHud wrapper.
        """
        cmd = ["mangohud"]

        cfg = config_path or self._config_path
        if cfg:
            cmd.extend(["--config", str(cfg)])

        cmd.extend(game_command)
        return cmd

    def find_latest_log(self, log_dir: Path) -> Optional[Path]:
        """
        Find the most recent MangoHud log in a directory.

        Args:
            log_dir: Directory to search.

        Returns:
            Path to most recent log file, or None.
        """
        # Try all CSV files - MangoHud names logs differently based on game
        # Exclude summary files (MangoHud creates *_summary.csv alongside main log)
        logs = [p for p in log_dir.glob("*.csv") if "_summary" not in p.name]

        if not logs:
            return None

        # Return most recently modified
        return max(logs, key=lambda p: p.stat().st_mtime)

    def find_all_logs(self, log_dir: Path) -> list[Path]:
        """
        Find all MangoHud logs in a directory.

        Args:
            log_dir: Directory to search.

        Returns:
            List of log file paths, sorted by modification time.
        """
        logs = list(log_dir.glob("MangoHud_*.csv"))
        if not logs:
            logs = list(log_dir.glob("*.csv"))

        # Exclude summary files
        logs = [p for p in logs if "_summary" not in p.name]

        return sorted(logs, key=lambda p: p.stat().st_mtime)

    def validate_log(self, log_path: Path) -> dict:
        """
        Validate a MangoHud log file.

        Args:
            log_path: Path to log file.

        Returns:
            Dictionary with validation results.
        """
        result = {
            "valid": False,
            "rows": 0,
            "duration_ms": 0,
            "has_fps": False,
            "has_frametime": False,
            "error": None,
        }

        try:
            if not log_path.exists():
                result["error"] = "File not found"
                return result

            content = log_path.read_text()
            lines = content.strip().split("\n")

            if len(lines) < 2:
                result["error"] = "Log file too short (no data)"
                return result

            # Find the header line (new MangoHud format has section markers)
            header = None
            data_start = 0
            for i, line in enumerate(lines):
                if "FRAME METRICS" in line:
                    # Next line is the header
                    if i + 1 < len(lines):
                        header = lines[i + 1].lower()
                        data_start = i + 2
                    break
                elif line.startswith("fps,") or ",frametime," in line.lower():
                    header = line.lower()
                    data_start = i + 1
                    break

            if header is None:
                # Try first line as fallback (old format)
                header = lines[0].lower()
                data_start = 1

            result["has_fps"] = "fps" in header
            result["has_frametime"] = "frametime" in header or "frame_time" in header

            if not result["has_fps"] and not result["has_frametime"]:
                result["error"] = "Log missing FPS and frametime columns"
                return result

            # Count data rows
            result["rows"] = len(lines) - data_start

            # Try to calculate duration from frametime
            if result["has_frametime"] and header:
                try:
                    # Find frametime column index from header
                    headers = header.split(",")
                    ft_idx = None
                    for i, h in enumerate(headers):
                        if "frametime" in h.lower() or "frame_time" in h.lower():
                            ft_idx = i
                            break

                    if ft_idx is not None:
                        total_ms = 0.0
                        for line in lines[data_start:]:
                            parts = line.split(",")
                            if len(parts) > ft_idx:
                                try:
                                    total_ms += float(parts[ft_idx])
                                except ValueError:
                                    pass
                        result["duration_ms"] = total_ms
                except Exception:
                    pass

            result["valid"] = result["rows"] > 10  # Require at least 10 frames

        except Exception as e:
            result["error"] = str(e)

        return result


def check_mangohud_installation() -> dict:
    """
    Check MangoHud installation status.

    Returns:
        Dictionary with installation info.
    """
    info = {
        "installed": MangoHudManager.is_installed(),
        "version": None,
        "config_paths": [],
    }

    if info["installed"]:
        info["version"] = MangoHudManager.get_version()

        # Check common config locations
        config_locations = [
            Path.home() / ".config" / "MangoHud" / "MangoHud.conf",
            Path("/etc/MangoHud/MangoHud.conf"),
            Path.home() / ".config" / "MangoHud.conf",
        ]

        for loc in config_locations:
            if loc.exists():
                info["config_paths"].append(str(loc))

    return info
